<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.313">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>R Workshop - Part 1</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="styles.scss">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">R Workshop</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html" rel="" target="">
 <span class="menu-text">Intro</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./data.html" rel="" target="" aria-current="page">
 <span class="menu-text">Part 1</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./transform.html" rel="" target="">
 <span class="menu-text">Part 2</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#summary" id="toc-summary" class="nav-link active" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#start-load-the-necessary-packages" id="toc-start-load-the-necessary-packages" class="nav-link" data-scroll-target="#start-load-the-necessary-packages">Start: Load the necessary packages</a></li>
  <li><a href="#getting-data" id="toc-getting-data" class="nav-link" data-scroll-target="#getting-data">Getting data</a></li>
  <li><a href="#loading-data" id="toc-loading-data" class="nav-link" data-scroll-target="#loading-data">Loading data</a>
  <ul class="collapse">
  <li><a href="#adding-labels-to-columns" id="toc-adding-labels-to-columns" class="nav-link" data-scroll-target="#adding-labels-to-columns">Adding labels to columns</a></li>
  </ul></li>
  <li><a href="#examining-data" id="toc-examining-data" class="nav-link" data-scroll-target="#examining-data">Examining data</a>
  <ul class="collapse">
  <li><a href="#table-meta-data-functions" id="toc-table-meta-data-functions" class="nav-link" data-scroll-target="#table-meta-data-functions">Table meta data functions</a></li>
  <li><a href="#data-viewers" id="toc-data-viewers" class="nav-link" data-scroll-target="#data-viewers">Data viewers</a></li>
  <li><a href="#getting-a-structured-overview" id="toc-getting-a-structured-overview" class="nav-link" data-scroll-target="#getting-a-structured-overview">Getting a structured overview</a></li>
  <li><a href="#examining-individual-columns" id="toc-examining-individual-columns" class="nav-link" data-scroll-target="#examining-individual-columns">Examining individual columns</a></li>
  </ul></li>
  <li><a href="#ensure-one-observation-per-unit-of-analysis" id="toc-ensure-one-observation-per-unit-of-analysis" class="nav-link" data-scroll-target="#ensure-one-observation-per-unit-of-analysis">Ensure one observation per unit of analysis</a></li>
  <li><a href="#saving-datasets" id="toc-saving-datasets" class="nav-link" data-scroll-target="#saving-datasets">Saving datasets</a></li>
  <li><a href="#plotting-to-understand-data" id="toc-plotting-to-understand-data" class="nav-link" data-scroll-target="#plotting-to-understand-data">Plotting to understand data</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Part 1</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>This part discusses a simple example of loading and examining financial data from WRDS. We discuss how to use coding to explore, understand, and document the characteristics of your data. While doing so you will learn the basics tidyverse and collapse commands. We will finish with a rudimentary analysis of changes in firm size over time by creating the following plot:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="size-by-year.png" class="img-fluid figure-img" style="width:5in"></p>
</figure>
</div>
</section>
<section id="start-load-the-necessary-packages" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="start-load-the-necessary-packages">Start: Load the necessary packages</h2>
<p>Once R, RStudio, and the relevant R packages are installed we can start analyzing data. To load the data and start examining it, we want access to a few additional functions that are not in base R. The functions used in this chapter are contained in package collection called tidyverse. We also want to use some extra functionality in the {collapse} package. These packages contain very useful and popular extra functionality not included in base R. Anytime you want to load an R package for the extra functionality it brings, you type and execute a <code>library</code> function call:</p>
<div class="page-columns page-full"><p></p><div class="no-row-height column-margin column-container"><span class="">Put your library statements, etc. at the top of each script. This makes it easier to see what packages are needed to run the code that follows</span></div></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(collapse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>collapse 1.9.6, see ?`collapse-package` or ?`collapse-documentation`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attache Paket: 'collapse'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Das folgende Objekt ist maskiert 'package:stats':

    D</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.2     ✔ readr     2.1.4
✔ forcats   1.0.0     ✔ stringr   1.5.0
✔ ggplot2   3.4.3     ✔ tibble    3.2.1
✔ lubridate 1.9.2     ✔ tidyr     1.3.0
✔ purrr     1.0.2     </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter()      masks stats::filter()
✖ lubridate::is.Date() masks collapse::is.Date()
✖ dplyr::lag()         masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
</div>
<p>These two lines load the collapse package and the core tidyverse packages like ggplot2, dplyr, etc. It tells you in the message under “Attaching core tidyverse packages” exactly which packages it attached and which versions. It also tells you which functions from the loaded packages have a name conflict with functions in base R (or from other packages you might have loaded).</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>If you get an error there is no package called ‘tidyverse’, you’ll need to first install it, then run library() again.The command is</p>
<pre><code>install.packages("tidyverse")</code></pre>
<p>You only need to install a package once, but you need to load it every time you start a new session.</p>
</div></div><p>Once we have the packages loaded, we can start using their extra functionality. The tidyverse packages introduce an R coding framework that is slightly different from base R. Arguably, it is easier and still powerful. These days, it is probably the most common way of coding in R, which is why we chose to teach you using tidyverse mechanics and not pure base R. This does not mean that you cannot do what we do with standard R functions, but it is often clumsier.</p>
</section>
<section id="getting-data" class="level2">
<h2 class="anchored" data-anchor-id="getting-data">Getting data</h2>
<p>Because you will mostly encounter financial data in your professional life as well as the master program, our examples will be based on standard financial databases. This should help you a lot later on, for example when you start your replication study. Normally you would download this data from <a href="wrds-web.wharton.upenn.edu/">WRDS</a> or access the data directly from a database. In the interest of time, we provide you with a raw dataset.</p>
</section>
<section id="loading-data" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="loading-data">Loading data</h2>
<p>Say we have downloaded some data from the Compustat North America file from <a href="wrds-web.wharton.upenn.edu/">WRDS</a> and put it into a folder called <code>data/</code>. We labelled the file “ccm-raw-2023-08-08-csv”. That name is deliberate as it denotes that the file contains the raw, untouched data and shows the date it was downloaded.</p>
<p>The Compustat North America file contains some selected financial variables for publicly listed firms in North America. We want to load that file into R, so that we can examine it. The following code line does that:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>ccm_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/ccm-raw-2023-08-08-csv.zip"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 271143 Columns: 29
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr  (16): GVKEY, LINKPRIM, LIID, LINKTYPE, indfmt, consol, popsrc, datafmt,...
dbl  (12): LPERMNO, fyear, fyr, at, ceq, che, dlc, dltt, ib, oiadp, sale, exchg
date  (1): datadate

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
</div>
<div class="page-columns page-full"><p><code>readr::read_csv</code> is a function for—your guessed it—loading “.csv” files (csv: comma separated value).<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>  This line can be read from left to right as: “create an object called <code>ccm_raw</code>, assign (<code>&lt;-</code>) to it the result of the function call <code>read_csv()</code>”. The result of read_csv is whatever that function does to its input. The input in this case is a file path in string form: “data/ccm-raw-2023-08-08-csv.zip”. Good function names tell you what the function does. In this case, it is pretty expressive: the function reads in a csv file. (Here, it actually reads in a zip file that contains a .csv file.) So what is the content of <code>ccm_raw</code> now? If you type the object name into the console and hit execute, you see that <code>ccm_raw</code> is a <a href="https://tibble.tidyverse.org/">tibble</a>, a type of data table.</p><div class="no-row-height column-margin column-container"><span class="">When we first introduce a function, we will use a package::function notation (e.g., <code>readr::read_csv</code>) to point to the package the function is included in. So that you know what packages need to be loaded before you can run the code</span></div></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>ccm_raw</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 271,143 × 29
   GVKEY  LINKPRIM LIID  LINKTYPE LPERMNO datadate   fyear indfmt consol popsrc
   &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;      &lt;dbl&gt; &lt;date&gt;     &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt; 
 1 001001 P        01    LU         10015 1983-12-31  1983 INDL   C      D     
 2 001001 P        01    LU         10015 1984-12-31  1984 INDL   C      D     
 3 001001 P        01    LU         10015 1985-12-31  1985 INDL   C      D     
 4 001003 C        01    LU         10031 1983-12-31  1983 INDL   C      D     
 5 001003 C        01    LU         10031 1984-12-31  1984 INDL   C      D     
 6 001003 C        01    LU         10031 1986-01-31  1985 INDL   C      D     
 7 001003 C        01    LU         10031 1987-01-31  1986 INDL   C      D     
 8 001003 C        01    LU         10031 1988-01-31  1987 INDL   C      D     
 9 001003 C        01    LU         10031 1989-01-31  1988 INDL   C      D     
10 001004 P        01    LU         54594 1981-05-31  1980 INDL   C      D     
# ℹ 271,133 more rows
# ℹ 19 more variables: datafmt &lt;chr&gt;, tic &lt;chr&gt;, cusip &lt;chr&gt;, conm &lt;chr&gt;,
#   curcd &lt;chr&gt;, fyr &lt;dbl&gt;, at &lt;dbl&gt;, ceq &lt;dbl&gt;, che &lt;dbl&gt;, dlc &lt;dbl&gt;,
#   dltt &lt;dbl&gt;, ib &lt;dbl&gt;, oiadp &lt;dbl&gt;, sale &lt;dbl&gt;, exchg &lt;dbl&gt;, costat &lt;chr&gt;,
#   fic &lt;chr&gt;, priusa &lt;chr&gt;, sic &lt;chr&gt;</code></pre>
</div>
</div>
<p>Tibbles are the tidyverse versions of data tables. Similar to tables you are familiar with from Excel. They are also called data frames in many statistical programming languages. Data frames are the data container type you will encounter most. There are other container types, like <code>matrix</code>, which is a simpler data container that is mostly used for matrix algebra. We won’t spend time on those, because you’ll be mostly concerned with data in table form.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>ccm_raw <span class="ot">&lt;-</span> <span class="fu">rename</span>(ccm_raw, </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">gvkey =</span> GVKEY, <span class="at">permno =</span> LPERMNO,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">liid =</span> LIID, <span class="at">linktype =</span> LINKTYPE, <span class="at">linkprim =</span> LINKPRIM)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="adding-labels-to-columns" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="adding-labels-to-columns">Adding labels to columns</h3>
<div class="page-columns page-full"><p>This is not mandatory, but can make your life a lot easier. Especially if you get data with semi-cryptic names. Assigning labels to to columns will help you (and potential coauthors) later to remember what you are looking at. Some functions can also take advantage of labels. <code>collapse::vlabels</code> can be used to assign labels. You do so by assigning a “named vector” (using the concatenate <code>c()</code> function to create the vector) to <code>vlabels(DATAFRAMENAME)</code>:</p><div class="no-row-height column-margin column-container"><span class="">You can also just rename columns; give them more expressive names. For commercial datasets, we think it is better to keep the standard names for the raw data.</span></div></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">vlabels</span>(ccm_raw) <span class="ot">&lt;-</span> <span class="fu">c</span>( </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># order must be the same as the columns:</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"gvkey"</span> <span class="ot">=</span> <span class="st">"Standard and Poor's Identifier"</span>,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"linkprim"</span> <span class="ot">=</span> <span class="st">"Primary Link Marker"</span>,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"liid"</span> <span class="ot">=</span> <span class="st">"Security-level Identifier"</span>,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"linktype"</span> <span class="ot">=</span> <span class="st">"Link Type Code"</span>,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"permno"</span> <span class="ot">=</span> <span class="st">"Historical CRSP Identifier"</span>,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"datadate"</span> <span class="ot">=</span> <span class="st">"Fiscal Year-End Date"</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"fyear"</span> <span class="ot">=</span> <span class="st">"Data Year - Fiscal"</span>,</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"indfmt"</span> <span class="ot">=</span> <span class="st">"Industry Format"</span>,</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"consol"</span> <span class="ot">=</span> <span class="st">"Consolidation Level"</span>,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"popsrc"</span> <span class="ot">=</span> <span class="st">"Population Source"</span>,</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"datafmt"</span> <span class="ot">=</span> <span class="st">"Data Format"</span>,</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"tic"</span> <span class="ot">=</span> <span class="st">"Ticker Symbol"</span>,</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"cusip"</span> <span class="ot">=</span> <span class="st">"CUSIP"</span>,</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"conm"</span> <span class="ot">=</span> <span class="st">"Company Name"</span>,</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"curcd"</span> <span class="ot">=</span> <span class="st">"Currency"</span>,</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">"fyr"</span> <span class="ot">=</span> <span class="st">"Fiscal Year-End"</span>,</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">"at"</span> <span class="ot">=</span> <span class="st">"Assets - Total"</span>,</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ceq"</span> <span class="ot">=</span> <span class="st">"Common/Ordinary Equity - Total"</span>,</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">"che"</span> <span class="ot">=</span> <span class="st">"Cash and Short-Term Investments"</span>,</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">"dlc"</span> <span class="ot">=</span> <span class="st">"Debt in Current Liabilities - Total"</span>,</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">"dltt"</span> <span class="ot">=</span> <span class="st">"Long-Term Debt - Total"</span>,</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ib"</span> <span class="ot">=</span> <span class="st">"Income Before Extraordinary Items"</span>,</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">"oiadp"</span> <span class="ot">=</span> <span class="st">"Operating Income After Depreciation"</span>,</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">"sale"</span> <span class="ot">=</span> <span class="st">"Sales/Turnover (Net)"</span>,</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">"exchg"</span> <span class="ot">=</span> <span class="st">"Stock Exchange Code"</span>,</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">"costat"</span> <span class="ot">=</span> <span class="st">"Company Status"</span>,</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">"fic"</span> <span class="ot">=</span> <span class="st">"Foreign Incorporation Code"</span>,</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>  <span class="st">"priusa"</span> <span class="ot">=</span> <span class="st">"PRIUSA -- Current Primary Issue Tag"</span>,</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>  <span class="st">"sic"</span> <span class="ot">=</span> <span class="st">"Standard Industry Classification Code"</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="examining-data" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="examining-data">Examining data</h2>
<section id="table-meta-data-functions" class="level3">
<h3 class="anchored" data-anchor-id="table-meta-data-functions">Table meta data functions</h3>
<p>When you typed <code>ccm_raw</code>, R did not print the full table. It tells you that there are 271,133 more rows and 19 more variables that you don’t see here. This printing behavior is mostly to save you from accidentally outputting huge datasets and freeze your machine. There are other functions to help you get a better overview of the data contained in the tibble. One is <code>dplyr::glimpse</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(ccm_raw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 271,143
Columns: 29
$ gvkey    &lt;chr&gt; "001001", "001001", "001001", "001003", "001003", "001003", "…
$ linkprim &lt;chr&gt; "P", "P", "P", "C", "C", "C", "C", "C", "C", "P", "P", "P", "…
$ liid     &lt;chr&gt; "01", "01", "01", "01", "01", "01", "01", "01", "01", "01", "…
$ linktype &lt;chr&gt; "LU", "LU", "LU", "LU", "LU", "LU", "LU", "LU", "LU", "LU", "…
$ permno   &lt;dbl&gt; 10015, 10015, 10015, 10031, 10031, 10031, 10031, 10031, 10031…
$ datadate &lt;date&gt; 1983-12-31, 1984-12-31, 1985-12-31, 1983-12-31, 1984-12-31, …
$ fyear    &lt;dbl&gt; 1983, 1984, 1985, 1983, 1984, 1985, 1986, 1987, 1988, 1980, 1…
$ indfmt   &lt;chr&gt; "INDL", "INDL", "INDL", "INDL", "INDL", "INDL", "INDL", "INDL…
$ consol   &lt;chr&gt; "C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "C", "…
$ popsrc   &lt;chr&gt; "D", "D", "D", "D", "D", "D", "D", "D", "D", "D", "D", "D", "…
$ datafmt  &lt;chr&gt; "STD", "STD", "STD", "STD", "STD", "STD", "STD", "STD", "STD"…
$ tic      &lt;chr&gt; "AMFD.", "AMFD.", "AMFD.", "ANTQ", "ANTQ", "ANTQ", "ANTQ", "A…
$ cusip    &lt;chr&gt; "000165100", "000165100", "000165100", "000354100", "00035410…
$ conm     &lt;chr&gt; "A &amp; M FOOD SERVICES INC", "A &amp; M FOOD SERVICES INC", "A &amp; M …
$ curcd    &lt;chr&gt; "USD", "USD", "USD", "USD", "USD", "USD", "USD", "USD", "USD"…
$ fyr      &lt;dbl&gt; 12, 12, 12, 12, 12, 1, 1, 1, 1, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5,…
$ at       &lt;dbl&gt; 14.080, 16.267, 39.495, 8.529, 8.241, 13.990, 14.586, 16.042,…
$ ceq      &lt;dbl&gt; 7.823, 8.962, 13.014, 6.095, 6.482, 6.665, 7.458, 7.643, -0.1…
$ che      &lt;dbl&gt; 4.280, 1.986, 2.787, 2.023, 0.844, 0.005, 0.241, 0.475, 0.302…
$ dlc      &lt;dbl&gt; 0.520, 0.597, 8.336, 0.250, 0.350, 0.018, 0.013, 0.030, 7.626…
$ dltt     &lt;dbl&gt; 4.344, 4.181, 11.908, 0.950, 0.600, 4.682, 3.750, 5.478, 0.10…
$ ib       &lt;dbl&gt; 1.135, 1.138, 2.576, 1.050, 0.387, 0.236, 0.793, -0.525, -7.8…
$ oiadp    &lt;dbl&gt; 1.697, 1.892, 5.238, 2.089, 0.732, 0.658, 1.933, -0.405, -4.3…
$ sale     &lt;dbl&gt; 25.395, 32.007, 53.798, 13.793, 13.829, 24.189, 36.308, 37.35…
$ exchg    &lt;dbl&gt; 14, 14, 14, 19, 19, 19, 19, 19, 19, 11, 11, 11, 11, 11, 11, 1…
$ costat   &lt;chr&gt; "I", "I", "I", "I", "I", "I", "I", "I", "I", "A", "A", "A", "…
$ fic      &lt;chr&gt; "USA", "USA", "USA", "USA", "USA", "USA", "USA", "USA", "USA"…
$ priusa   &lt;chr&gt; "01", "01", "01", "01", "01", "01", "01", "01", "01", "01", "…
$ sic      &lt;chr&gt; "5812", "5812", "5812", "5712", "5712", "5712", "5712", "5712…</code></pre>
</div>
</div>
<p><code>glimpse</code> just shows you in compact form: 1) the number of rows, 2) the number of columns, 3) all column names, 4) column types, and 5) the first values in each column in the table</p>
<p>An alternative to <code>glimpse</code> that does not rely on <code>dplyr</code> being loaded in is the base R function: <code>base::str</code>. But it is usually less clean, so we prefer glimpse.</p>
</section>
<section id="data-viewers" class="level3">
<h3 class="anchored" data-anchor-id="data-viewers">Data viewers</h3>
<p>If you use RStudio or VScode as your IDE (integrated development environment), then you can also view tibbles/data.frames/data.tables in a viewer. In RStudio, you can click on the tibble name “ccm_raw” in the environment pane, hitting the F2-key if the cursor is on the “ccm_raw” also opens the data viewer. Or you can use the function <code>tibble::view</code> to start the data viewer.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">view</span>(ccm_raw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="getting-a-structured-overview" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="getting-a-structured-overview">Getting a structured overview</h3>
<p>When dealing with large datasets, looking at the data viewer will not be enough. One of the first things you should do is to get a better feeling for the data you are dealing with. If you want to get a glimpse of what countries are in this dataset, you cannot just browse through 300,000 rows. It will take too long and it is easy to miss a rarely occurring patterns.</p>
<p>Things like examining the distinct values in a column help you a lot in better understanding your data. You can use the <code>collapse::fndistinct</code> function to check the number of distinct values per column</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fndistinct</span>(ccm_raw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   gvkey linkprim     liid linktype   permno datadate    fyear   indfmt 
   25614        4       23        2    26099      518       44        1 
  consol   popsrc  datafmt      tic    cusip     conm    curcd      fyr 
       1        1        1    25613    25614    25612        2       12 
      at      ceq      che      dlc     dltt       ib    oiadp     sale 
  203359   176724   113664    70320   117375   118348   130310   185004 
   exchg   costat      fic   priusa      sic 
      15        2       64       23      449 </code></pre>
</div>
</div>
<p>There are a few columns with just one distinct value. We don’t need those anymore. They were used to filter the raw data. In case you do not know/remember what those columns were, look at the labels.</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-10"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><a class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-10-1" class="code-annotation-target"><a href="#annotated-cell-10-1" aria-hidden="true" tabindex="-1"></a>ccm_raw <span class="sc">|&gt;</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-10-2" class="code-annotation-target"><a href="#annotated-cell-10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(indfmt, consol, popsrc, datafmt) <span class="sc">|&gt;</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-10-3" class="code-annotation-target"><a href="#annotated-cell-10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">namlab</span>()</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-10" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="1" data-code-annotation="1">Start with the <code>ccm_raw</code> dataset</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="2" data-code-annotation="2">Select four columns, throw the rest away (using <code>dplyr::select</code>)</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="3" data-code-annotation="3">Call <code>namlab</code>on the reduced tibble to see the column labels for the selected labels</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Variable               Label
1   indfmt     Industry Format
2   consol Consolidation Level
3   popsrc   Population Source
4  datafmt         Data Format</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-11"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-11-1"><a href="#annotated-cell-11-1" aria-hidden="true" tabindex="-1"></a>ccm_raw <span class="sc">|&gt;</span>                                    </span>
<span id="annotated-cell-11-2"><a href="#annotated-cell-11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(indfmt, consol, popsrc, datafmt) <span class="sc">|&gt;</span>  </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-11" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-11-3" class="code-annotation-target"><a href="#annotated-cell-11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">funique</span>()</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-11" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-11" data-code-lines="3" data-code-annotation="1"><code>collapse::funique</code> shows only unique combinations in a data frame.</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
  indfmt consol popsrc datafmt
  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;  
1 INDL   C      D      STD    </code></pre>
</div>
</div>
<p>Above, we used what is called a <em>pipe operator</em> <code>|&gt;</code>. It allows us to <em>chain</em> together a sequence of steps. When you see a <code>|&gt;</code>, it means “take the result of what is left of <code>|&gt;</code> and put it as the first input to what is right of <code>|&gt;</code>.</p>
<div class="page-columns page-full"><p>Back to the topic at hand, we do not need the columns: indfmt, consol, popsrc, datafmt. Let us get rid of them. We do so by generating a new dataset, which we call <code>ccm</code> and using a “negative” select call.</p><div class="no-row-height column-margin column-container"><span class="">We like to keep the raw data untouched when filtering and cleaning data</span></div></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>ccm <span class="ot">&lt;-</span> </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  ccm_raw <span class="sc">|&gt;</span> </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>indfmt, <span class="sc">-</span>consol, <span class="sc">-</span>popsrc, <span class="sc">-</span>datafmt) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="examining-individual-columns" class="level3">
<h3 class="anchored" data-anchor-id="examining-individual-columns">Examining individual columns</h3>
<p>You would usually spend some more time understanding the data. For example, what about those with 2 values? We can use <code>collapse::descr</code> to provide some descriptive statistics. Notice how it also uses the labels we provided before.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>ccm <span class="sc">|&gt;</span> </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(curcd, costat) <span class="sc">|&gt;</span> </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">descr</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset: costat, 2 Variables, N = 271143
--------------------------------------------------------------------------------
curcd (character): Currency
Statistics (0% NAs)
       N  Ndist
  271141      2
Table
       Freq   Perc
USD  266735  98.38
CAD    4406   1.62
--------------------------------------------------------------------------------
costat (character): Company Status
Statistics
       N  Ndist
  271143      2
Table
     Freq   Perc
I  162350  59.88
A  108793  40.12
--------------------------------------------------------------------------------</code></pre>
</div>
</div>
<p>Depending on how we define our setting, we might want to get rid of those financials in Canadian dollars <code>curcd == "CAD"</code>. <code>costat</code>shows that 60% of our sample has the inactive status.</p>
<p>We can also call <code>descr</code> on single columns using <code>$</code> to select a single column:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">descr</span>(ccm<span class="sc">$</span>fic)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset: fic, 1 Variables, N = 271143
--------------------------------------------------------------------------------
fic (character): Foreign Incorporation Code
Statistics
       N  Ndist
  271143     64
Table
                 Freq   Perc
USA            241894  89.21
CAN              7703   2.84
CYM              2781   1.03
ISR              2418   0.89
GBR              2195   0.81
BMU              1806   0.67
IRL              1070   0.39
JPN               973   0.36
NLD               868   0.32
VGB               783   0.29
MHL               656   0.24
MEX               634   0.23
AUS               537   0.20
FRA               512   0.19
... 50 Others    6313   2.33

Summary of Table Frequencies
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
      3      31     130    4237     373  241894 
--------------------------------------------------------------------------------</code></pre>
</div>
</div>
<p>There are 69 different countries of incorporation in this dataset. Most incorporated in the USA. We learn something interesting about the dataset. Not all firms in the North America Dataset are located in North America. Most firm-year obs are associated with USA incorporation. Some are incorporated in Canada, the next most often occurring is Cayman islands. Depending on our research question, we might want to restrict our sample only to firms incorporated in the US. Before making that call, however, we might want to explore the data a bit more.</p>
<p>We see that some observations are from firms incorporated in the Netherlands. Let us extract a sample of names of those companies.</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-15"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><a class="code-annotation-anchor" data-target-cell="annotated-cell-15" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-15-1" class="code-annotation-target"><a href="#annotated-cell-15-1" aria-hidden="true" tabindex="-1"></a>ccm <span class="sc">|&gt;</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-15" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-15-2" class="code-annotation-target"><a href="#annotated-cell-15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(fic <span class="sc">==</span> <span class="st">"NLD"</span>) <span class="sc">|&gt;</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-15" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-15-3" class="code-annotation-target"><a href="#annotated-cell-15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(conm) <span class="sc">|&gt;</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-15" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-15-4" class="code-annotation-target"><a href="#annotated-cell-15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">|&gt;</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-15" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-15-5" class="code-annotation-target"><a href="#annotated-cell-15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">20</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-15" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-15" data-code-lines="1" data-code-annotation="1">Start with the table ccm_raw</span>
</dd>
<dt data-target-cell="annotated-cell-15" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-15" data-code-lines="2" data-code-annotation="2">Reduce the table to only rows with fic equaling (<code>==</code>) “NLD”</span>
</dd>
<dt data-target-cell="annotated-cell-15" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-15" data-code-lines="3" data-code-annotation="3"><code>dplyr::pull</code> extracts the “conm” column from the reduce table into a vector</span>
</dd>
<dt data-target-cell="annotated-cell-15" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-15" data-code-lines="4" data-code-annotation="4">Reduce to only unique values in the vector</span>
</dd>
<dt data-target-cell="annotated-cell-15" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-15" data-code-lines="5" data-code-annotation="5">Show the first 20 values in the vector</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "ASM INTERNATIONAL NV"         "KLM-ROYAL DUTCH AIRLINES"    
 [3] "OCE NV"                       "KONINKLIJKE PHILIPS NV"      
 [5] "ROYAL DUTCH PETROLEUM NV"     "AUSIMONT NV"                 
 [7] "FIAT CHRYSLER AUTOMOBILES NV" "AKZO NOBEL NV"               
 [9] "ABN-AMRO HOLDINGS NV"         "AEGON NV"                    
[11] "ING GROEP NV"                 "FRANK'S INTL NV"             
[13] "PROSENSA HOLDING NV"          "POLYGRAM NV"                 
[15] "PATHEON NV"                   "MOBILEYE NV"                 
[17] "CNOVA NV"                     "PROQR THERAPEUTICS NV"       
[19] "AFFIMED NV"                   "MEMOREX TELEX NV  -ADR"      </code></pre>
</div>
</div>
<p>The NLD firms are likely larger internationals that are listed on one of the US exchanges in some form, so that they have to file with the SEC (Companies listed on a US exchange must file financial statements with the SEC). Let’s look at ASM for example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-16"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><a class="code-annotation-anchor" data-target-cell="annotated-cell-16" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-16-1" class="code-annotation-target"><a href="#annotated-cell-16-1" aria-hidden="true" tabindex="-1"></a>ccm <span class="sc">|&gt;</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-16" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-16-2" class="code-annotation-target"><a href="#annotated-cell-16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(conm <span class="sc">==</span> <span class="st">"ASM INTERNATIONAL NV"</span>) <span class="sc">|&gt;</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-16" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-16-3" class="code-annotation-target"><a href="#annotated-cell-16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(tic, cusip, conm, curcd, exchg) <span class="sc">|&gt;</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-16" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-16-4" class="code-annotation-target"><a href="#annotated-cell-16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>()</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-16" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-16" data-code-lines="1" data-code-annotation="1">Start with the table ccm_raw</span>
</dd>
<dt data-target-cell="annotated-cell-16" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-16" data-code-lines="2" data-code-annotation="2">Reduce the table to only rows with conm equaling (<code>==</code>) “ASM INTERNATIONAL NV”</span>
</dd>
<dt data-target-cell="annotated-cell-16" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-16" data-code-lines="3" data-code-annotation="3">Reduce the reduced table further to only contain the columns tic, cusip, conm, curcd, exchg</span>
</dd>
<dt data-target-cell="annotated-cell-16" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-16" data-code-lines="4" data-code-annotation="4"><code>dplyr::distinct</code>drops all repeating rows in the reduced table (could have also used <code>funique</code>)</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 5
  tic   cusip     conm                 curcd exchg
  &lt;chr&gt; &lt;chr&gt;     &lt;chr&gt;                &lt;chr&gt; &lt;dbl&gt;
1 ASMIY N07045102 ASM INTERNATIONAL NV USD      19</code></pre>
</div>
</div>
<p>As the example above shows: <code>dplyr::select</code> and <code>dplyr::filter</code> are two fundamental slicing and indexing functions. <code>filter</code> is for rows and <code>select</code>is for columns.</p>
<p>The purpose here was to examine what ticker, currency, and stock exchange code ASM is associated with. We also want to check there is more than one combination of values for these five columns (there is not). For example, ASM is in our sample for more than one year and it might have changed its ticker over time, etc.). We see that ASM has a ticker and an exchg code of 19, which means “Other-OTC” per the compustat <a href="https://wrds-www.wharton.upenn.edu/documents/1583/Compustat_Data_Guide.pdf">data guide</a>. These can include international filers. In fact, most of the observations fall into category 19 (another one, 14, is NASDAQ). Depending on the intended sample—US firms or firms listed in the US—we might want to exclude them.</p>
</section>
</section>
<section id="ensure-one-observation-per-unit-of-analysis" class="level2">
<h2 class="anchored" data-anchor-id="ensure-one-observation-per-unit-of-analysis">Ensure one observation per unit of analysis</h2>
<p>When you perform analyses, it is important that you are clear what your unit of analysis is. Let’s say that our unit of analysis is a firm-fiscal year. In that case, we need to check whether we have one observation per unit of analysis.</p>
<p>We can do this we simple counts.<code>dplyr::count</code> is a handy function for this. <code>count</code>, as the name suggests, counts how often a value of a set of variables occurs in the dataset. The first input you provide is the dataset, the next inputs are the column names to base the count on:</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-17"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-17-1"><a href="#annotated-cell-17-1" aria-hidden="true" tabindex="-1"></a>ccm <span class="sc">|&gt;</span> </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-17" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-17-2" class="code-annotation-target"><a href="#annotated-cell-17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(gvkey, datadate) <span class="sc">|&gt;</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-17" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-17-3" class="code-annotation-target"><a href="#annotated-cell-17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-17" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-17" data-code-lines="2" data-code-annotation="1">Count how many observations exist for each unique gvkey x datadate combination</span>
</dd>
<dt data-target-cell="annotated-cell-17" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-17" data-code-lines="3" data-code-annotation="2">Show the first six observations in the resulting tibble</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  gvkey  datadate       n
  &lt;chr&gt;  &lt;date&gt;     &lt;int&gt;
1 001001 1983-12-31     1
2 001001 1984-12-31     1
3 001001 1985-12-31     1
4 001003 1983-12-31     1
5 001003 1984-12-31     1
6 001003 1986-01-31     1</code></pre>
</div>
</div>
<p>For example, the combination gvkey 001001 x date 1983-12-31 occurs exactly once in the datset <code>ccm</code>. We can combine two <code>count</code> calls to see whether we have anything to worry about:</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-18"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-18-1"><a href="#annotated-cell-18-1" aria-hidden="true" tabindex="-1"></a>ccm <span class="sc">|&gt;</span> </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-18" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-18-2" class="code-annotation-target"><a href="#annotated-cell-18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(gvkey, datadate, <span class="at">name =</span> <span class="st">"firm_year"</span>) <span class="sc">|&gt;</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-18" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-18-3" class="code-annotation-target"><a href="#annotated-cell-18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(firm_year)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-18" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-18" data-code-lines="2" data-code-annotation="1">Count how many observations exist for each unique gvkey x datadate combination. Call the count column “firm_year”</span>
</dd>
<dt data-target-cell="annotated-cell-18" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-18" data-code-lines="3" data-code-annotation="2">Count how often each value of the “firm_year” column occurs</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  firm_year      n
      &lt;int&gt;  &lt;int&gt;
1         1 265776
2         2   2607
3         3     51</code></pre>
</div>
</div>
<p>As you can see, there are a few gvkey x datadate combinations that occur twice, some even three times. Why is this happening? Let write some code to figure it out.</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-19"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-19-1"><a href="#annotated-cell-19-1" aria-hidden="true" tabindex="-1"></a>ccm_test <span class="ot">&lt;-</span> ccm <span class="sc">|&gt;</span> </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-19" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-19-2" class="code-annotation-target"><a href="#annotated-cell-19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_count</span>(gvkey, datadate, <span class="at">name =</span> <span class="st">"n_same_firm_year"</span>) <span class="sc">|&gt;</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-19" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-19-3" class="code-annotation-target"><a href="#annotated-cell-19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n_same_firm_year <span class="sc">&gt;</span> <span class="dv">1</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-19" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-19" data-code-lines="2" data-code-annotation="1"><code>dplyr::add_count</code> counts the number of rows with a specific gvkey x datadate value and <em>adds</em> that value to the rows with the respective gvkey x datadate value</span>
</dd>
<dt data-target-cell="annotated-cell-19" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-19" data-code-lines="3" data-code-annotation="2">Next we filter to only keep rows with a count higher than 1</span>
</dd>
</dl>
</div>
</div>
<p>Let’s look at the result and limit our output to only some selected columns and ten rows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>ccm_test <span class="sc">|&gt;</span> </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(gvkey, permno, datadate, liid, linkprim, linktype, exchg) <span class="sc">|&gt;</span> </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 7
   gvkey  permno datadate   liid  linkprim linktype exchg
   &lt;chr&gt;   &lt;dbl&gt; &lt;date&gt;     &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt;    &lt;dbl&gt;
 1 001076  10517 1993-03-31 01    J        LC          11
 2 001076  78049 1993-03-31 02    P        LC          11
 3 001076  78049 1994-03-31 02    P        LC          11
 4 001076  10517 1994-03-31 01    J        LC          11
 5 001076  10517 1995-03-31 01    J        LC          11
 6 001076  78049 1995-03-31 02    P        LC          11
 7 001076  78049 1995-12-31 02    P        LC          11
 8 001076  10517 1995-12-31 01    J        LC          11
 9 001076  10517 1996-12-31 01    J        LC          11
10 001076  78049 1996-12-31 02    P        LC          11</code></pre>
</div>
</div>
<p>From the output we can see that the reason is that this dataset has another company identifier (permno) merged to it already. This is the identifier we will need in the second part to merge stock return data to this sample. It can happen that one gvkey is associated with more than one permno. Sometimes there are primary and secondary links.</p>
<p>We decided that our unit of analysis is firm-year, not security-year. Hence we only want one unique observation per firm-year. For that, we will need to do some filtering. Let us reduce the data to rows that either are a unique gvkey x datadate combination, or are labelled as primary link between compustat and crsp (which we will need later to join return data on it). We will also filter to companies incorporated in the US. (e.g., as we would want to if we look at some US-GAAP specific analysis).</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-21"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-21-1"><a href="#annotated-cell-21-1" aria-hidden="true" tabindex="-1"></a>ccm_unique <span class="ot">&lt;-</span> ccm <span class="sc">|&gt;</span> </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-21" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-21-2" class="code-annotation-target"><a href="#annotated-cell-21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_count</span>(gvkey, datadate, <span class="at">name =</span> <span class="st">"n_same_firm_year"</span>) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-21-3"><a href="#annotated-cell-21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(             </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-21" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-21-4" class="code-annotation-target"><a href="#annotated-cell-21-4" aria-hidden="true" tabindex="-1"></a>    n_same_firm_year <span class="sc">==</span> <span class="dv">1</span> <span class="sc">|</span> linkprim <span class="sc">==</span> <span class="st">"P"</span>,  <span class="co"># "|" means "or"</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-21" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-21-5" class="code-annotation-target"><a href="#annotated-cell-21-5" aria-hidden="true" tabindex="-1"></a>    fic <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"USA"</span>)</span>
<span id="annotated-cell-21-6"><a href="#annotated-cell-21-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span>   </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-21" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-21-7" class="code-annotation-target"><a href="#annotated-cell-21-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>n_same_firm_year)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-21" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-21" data-code-lines="2" data-code-annotation="1">Count how many observations exist for each unique gvkey x datadate combination. Call the count column “firm_year”</span>
</dd>
<dt data-target-cell="annotated-cell-21" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-21" data-code-lines="4" data-code-annotation="2">Keep rows with either n_same_firm_year == 1 or linkprim == “P”</span>
</dd>
<dt data-target-cell="annotated-cell-21" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-21" data-code-lines="5" data-code-annotation="3">Keep rows with fic in a list of values (“USA”)</span>
</dd>
<dt data-target-cell="annotated-cell-21" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-21" data-code-lines="7" data-code-annotation="4">Delete the column “n_same_firm_year”</span>
</dd>
</dl>
</div>
</div>
<p>We should now have one observation per gvkey x datadate unit of analysis. Let us double-check whether it is indeed the case.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>ccm_unique <span class="sc">|&gt;</span> </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(gvkey, datadate, <span class="at">name =</span> <span class="st">"firm_year"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(firm_year)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
  firm_year      n
      &lt;int&gt;  &lt;int&gt;
1         1 239192</code></pre>
</div>
</div>
<p>We will leave it at that for now and save the result.</p>
</section>
<section id="saving-datasets" class="level2">
<h2 class="anchored" data-anchor-id="saving-datasets">Saving datasets</h2>
<p>You can save datasets to many different formats, e.g., back to .csv, to Stata or SAS files, excel files, and many many more. There is an R package for almost all file formats you might need. If you share data and don’t mind large files, csv is not a bad choice (e.g., using <code>readr::write_csv</code>). <em>Do not</em> save datsets to excel! Excel files have a row limit that is often exceeded and the chance that data formats and similar things get garbled is just too high. ({writexl} is a package including functions for writing excel files. {readxl} for reading).</p>
<p>R also has a way store datasets into binary format. These files are called .rds files. They are reasonably fast and compact, so not a bad choice for saving intermediate output that is not supposed to be stored permanently. We will use it now.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(ccm_unique, <span class="st">"data/ccm-unique.rds"</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="co"># readRDS for reading the file in again</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will continue preparing the sample in the second part of the workshop “Transforming Data”.</p>
</section>
<section id="plotting-to-understand-data" class="level2">
<h2 class="anchored" data-anchor-id="plotting-to-understand-data">Plotting to understand data</h2>
<p>A good plotting library is an incredibly powerful tool to not only present results but also to explore and understand data. See for example the <a href="https://bbc.github.io/rcookbook/">BBC Visual and Data Journalism cookbook for R graphics</a> for some great examples of good plots. In our case, we wan to get a better feeling for how the distribution of firm size in our dataset.</p>
<p>We could start with a simple histogram</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="annotated-cell-24"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-24-1"><a href="#annotated-cell-24-1" aria-hidden="true" tabindex="-1"></a>ccm_unique <span class="sc">|&gt;</span> </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-24" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-24-2" class="code-annotation-target"><a href="#annotated-cell-24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(at) <span class="sc">|&gt;</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-24" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-24-3" class="code-annotation-target"><a href="#annotated-cell-24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> at)) <span class="sc">+</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-24" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-24-4" class="code-annotation-target"><a href="#annotated-cell-24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">50</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-24" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-24" data-code-lines="2" data-code-annotation="1">Drop all rows with missing values of at (assets total) from the data frame</span>
</dd>
<dt data-target-cell="annotated-cell-24" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-24" data-code-lines="3" data-code-annotation="2">Create a plotting canvas with the x axis being mapped to at</span>
</dd>
<dt data-target-cell="annotated-cell-24" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-24" data-code-lines="4" data-code-annotation="3">Draw a histogram on the plot canvas using 50 bins</span>
</dd>
</dl>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="data_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Unfortunately, we do not see much here. The reason is the extremely skewed distribution of variables like total assets, sales, household income. There is always a “Apple Inc.” that is so much larger, or a “Jeff Bezoz” that is so much richer than everyone else. For variables that can only have positive values, taking the logarithm can yield in a much easier visualization. But we need a to be a bit careful with our log-taking. If we have negative values, the <code>log()</code> function will produce missing values and if we take the log of zero we get “negative infinity” as a result</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-25"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-25-1"><a href="#annotated-cell-25-1" aria-hidden="true" tabindex="-1"></a>ccm_unique <span class="sc">|&gt;</span> </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-25" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-25-2" class="code-annotation-target"><a href="#annotated-cell-25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Size =</span> <span class="fu">log</span>(at)) <span class="sc">|&gt;</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-25" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-25-3" class="code-annotation-target"><a href="#annotated-cell-25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(at, Size) <span class="sc">|&gt;</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-25" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-25-4" class="code-annotation-target"><a href="#annotated-cell-25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">qsu</span>()</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-25" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-25" data-code-lines="2" data-code-annotation="1">Mutate the data by taking the log of at and storing the result into a new column named “Size”</span>
</dd>
<dt data-target-cell="annotated-cell-25" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-25" data-code-lines="3" data-code-annotation="2">Only keep the columns at and Size. Drop all other columns</span>
</dd>
<dt data-target-cell="annotated-cell-25" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-25" data-code-lines="4" data-code-annotation="3"><code>collapse:qsu</code> computes a quick summary (qsu)</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>           N       Mean          SD   Min       Max
at    218211  4761.9387  47680.2673     0  3'743567
Size  218211          -           -  -Inf   15.1355</code></pre>
</div>
</div>
<p>The -Inf is a problem when plotting so we filter it out before</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="annotated-cell-26"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-26-1"><a href="#annotated-cell-26-1" aria-hidden="true" tabindex="-1"></a>ccm_unique <span class="sc">|&gt;</span> </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-26" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-26-2" class="code-annotation-target"><a href="#annotated-cell-26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Size =</span> <span class="fu">log</span>(at)) <span class="sc">|&gt;</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-26" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-26-3" class="code-annotation-target"><a href="#annotated-cell-26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.finite</span>(Size)) <span class="sc">|&gt;</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-26" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-26-4" class="code-annotation-target"><a href="#annotated-cell-26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Size)) <span class="sc">+</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-26" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-26-5" class="code-annotation-target"><a href="#annotated-cell-26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">50</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-26" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-26" data-code-lines="2" data-code-annotation="1">Mutate the data by taking the log of at and storing the result into a new column named “Size”</span>
</dd>
<dt data-target-cell="annotated-cell-26" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-26" data-code-lines="3" data-code-annotation="2">Drop all rows with infinite values of Size from the data frame</span>
</dd>
<dt data-target-cell="annotated-cell-26" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-26" data-code-lines="4" data-code-annotation="3">Create a plotting canvas with the x axis being mapped to Size</span>
</dd>
<dt data-target-cell="annotated-cell-26" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-26" data-code-lines="5" data-code-annotation="4">Draw a histogram on the plot canvas using 50 bins</span>
</dd>
</dl>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="data_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This looks much better. However, this is the distribution over all years in our sample. It might hide interesting patterns in the data. We could take a look at how the data changed over time. There is multiple ways we could try to visualize and explore such changes. Here is one. For this we need a third extra package called {ggrides}</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggridges)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you are surprised that you need an yet another package to run the code, you should be. As we said above, this is bad coding practice. Put all your library calls always at the top of your scripts, so that everyone can always see what is required to run all code. <a href="https://cran.r-project.org/web/packages/ggridges/vignettes/introduction.html">ggridges</a> contains functions to plot so-called ridge plots. We will use <code>ggridges::geom_density_ridges</code> for that.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="annotated-cell-28"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><a class="code-annotation-anchor" data-target-cell="annotated-cell-28" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-28-1" class="code-annotation-target"><a href="#annotated-cell-28-1" aria-hidden="true" tabindex="-1"></a>fig1 <span class="ot">&lt;-</span></span>
<span id="annotated-cell-28-2"><a href="#annotated-cell-28-2" aria-hidden="true" tabindex="-1"></a>  ccm_unique <span class="sc">|&gt;</span>                                          </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-28" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-28-3" class="code-annotation-target"><a href="#annotated-cell-28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Size =</span> <span class="fu">log</span>(at)) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-28-4"><a href="#annotated-cell-28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(                                                  </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-28" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-28-5" class="code-annotation-target"><a href="#annotated-cell-28-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">is.finite</span>(Size),</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-28" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-28-6" class="code-annotation-target"><a href="#annotated-cell-28-6" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(fyear) <span class="sc">&amp;</span> fyear <span class="sc">&lt;</span> <span class="dv">2023</span></span>
<span id="annotated-cell-28-7"><a href="#annotated-cell-28-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-28" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-28-8" class="code-annotation-target"><a href="#annotated-cell-28-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Size, <span class="at">y =</span> <span class="fu">as.factor</span>(fyear))) <span class="sc">+</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-28" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-28-9" class="code-annotation-target"><a href="#annotated-cell-28-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density_ridges</span>(</span>
<span id="annotated-cell-28-10"><a href="#annotated-cell-28-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale =</span> <span class="dv">5</span>, </span>
<span id="annotated-cell-28-11"><a href="#annotated-cell-28-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"coral"</span>, <span class="at">color =</span> <span class="st">"black"</span>,</span>
<span id="annotated-cell-28-12"><a href="#annotated-cell-28-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.2</span>, </span>
<span id="annotated-cell-28-13"><a href="#annotated-cell-28-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">rel_min_height =</span> <span class="fl">0.005</span></span>
<span id="annotated-cell-28-14"><a href="#annotated-cell-28-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-28" data-target-annotation="7" onclick="event.preventDefault();">7</a><span id="annotated-cell-28-15" class="code-annotation-target"><a href="#annotated-cell-28-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">5</span>, <span class="at">color =</span> <span class="st">"grey30"</span>) <span class="sc">+</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-28" data-target-annotation="8" onclick="event.preventDefault();">8</a><span id="annotated-cell-28-16" class="code-annotation-target"><a href="#annotated-cell-28-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_discrete</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="fl">0.01</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-28" data-target-annotation="9" onclick="event.preventDefault();">9</a><span id="annotated-cell-28-17" class="code-annotation-target"><a href="#annotated-cell-28-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="fl">0.01</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-28" data-target-annotation="10" onclick="event.preventDefault();">10</a><span id="annotated-cell-28-18" class="code-annotation-target"><a href="#annotated-cell-28-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-28" data-target-annotation="11" onclick="event.preventDefault();">11</a><span id="annotated-cell-28-19" class="code-annotation-target"><a href="#annotated-cell-28-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-28" data-target-annotation="12" onclick="event.preventDefault();">12</a><span id="annotated-cell-28-20" class="code-annotation-target"><a href="#annotated-cell-28-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="annotated-cell-28-21"><a href="#annotated-cell-28-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Fiscal Year"</span>,</span>
<span id="annotated-cell-28-22"><a href="#annotated-cell-28-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Firm Size (log of total assets)"</span>,</span>
<span id="annotated-cell-28-23"><a href="#annotated-cell-28-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Listed firms are much bigger today"</span>,</span>
<span id="annotated-cell-28-24"><a href="#annotated-cell-28-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Change in firm size distribution over time"</span>,</span>
<span id="annotated-cell-28-25"><a href="#annotated-cell-28-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Source: Compustat North America data (1980 - 2022). Not adjusted for inflation"</span></span>
<span id="annotated-cell-28-26"><a href="#annotated-cell-28-26" aria-hidden="true" tabindex="-1"></a>  )</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-28" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-28" data-code-lines="1" data-code-annotation="1">Store the result of the computation into variable called <code>fig1</code></span>
</dd>
<dt data-target-cell="annotated-cell-28" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-28" data-code-lines="3" data-code-annotation="2">Mutate the data by taking the log of at and storing the result into a new column named “Size”</span>
</dd>
<dt data-target-cell="annotated-cell-28" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-28" data-code-lines="5" data-code-annotation="3">Drop all rows with infinite values of Size from the data frame</span>
</dd>
<dt data-target-cell="annotated-cell-28" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-28" data-code-lines="6" data-code-annotation="4">Drop all rows with missing fiscal year (fyear) and fyear greater equal 2023</span>
</dd>
<dt data-target-cell="annotated-cell-28" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-28" data-code-lines="8" data-code-annotation="5">Create a plotting canvas with the x axis being mapped to Size and the y axis to fyear where fyear is transformed from an integer variable to a factor before. (A quirk of ggridges makes this necessary)</span>
</dd>
<dt data-target-cell="annotated-cell-28" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-28" data-code-lines="9" data-code-annotation="6">Draw a ridge plot on the plot canvas using a certain parameter configuration</span>
</dd>
<dt data-target-cell="annotated-cell-28" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-28" data-code-lines="15" data-code-annotation="7">Add a guiding vertical line that intersects the x axis at 5.</span>
</dd>
<dt data-target-cell="annotated-cell-28" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-28" data-code-lines="16" data-code-annotation="8">Reduce the padding around the x axis (The default padding is to much for my taste)</span>
</dd>
<dt data-target-cell="annotated-cell-28" data-target-annotation="9">9</dt>
<dd>
<span data-code-cell="annotated-cell-28" data-code-lines="17" data-code-annotation="9">Reduce the padding around the y axis</span>
</dd>
<dt data-target-cell="annotated-cell-28" data-target-annotation="10">10</dt>
<dd>
<span data-code-cell="annotated-cell-28" data-code-lines="18" data-code-annotation="10">Switch the standard grey theme to a lighter theme</span>
</dd>
<dt data-target-cell="annotated-cell-28" data-target-annotation="11">11</dt>
<dd>
<span data-code-cell="annotated-cell-28" data-code-lines="19" data-code-annotation="11">Remove some unnecessary gridlines</span>
</dd>
<dt data-target-cell="annotated-cell-28" data-target-annotation="12">12</dt>
<dd>
<span data-code-cell="annotated-cell-28" data-code-lines="20" data-code-annotation="12">Add annotations to finalize the plot</span>
</dd>
</dl>
</div>
</div>
<p>We have stored the plot into a variable called <code>fig1</code> instead of plotting it directly. This is useful for post-processing, saving, etc. Here is the plot in <code>fig1</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>fig1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Picking joint bandwidth of 0.361</code></pre>
</div>
<div class="cell-output-display">
<p><img src="data_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>And here is how to save it to disk in .png format (good for websites)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"size-by-year.png"</span>, fig1, <span class="at">width =</span> <span class="dv">7</span>, <span class="at">height =</span> <span class="dv">7</span>, <span class="at">units =</span> <span class="st">"in"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Picking joint bandwidth of 0.361</code></pre>
</div>
</div>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>These are essentially text files that you could open in a text editor to look at the values. They have the advantage that most programs can read them (because they are text files). The disadvantage is that they usually take more disk space and take longer to read. That is something you will only notice with big files though.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Base R also has a <code>data.frame</code> type, of which <code>tibble</code> is a derivative. There are also others, like <code>data.table</code> (which we won’t cover, even though it is awesome. It is is advanced stuff). Except for data.table, they are mostly interchangeable.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>